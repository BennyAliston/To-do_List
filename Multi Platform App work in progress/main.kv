#:kivy 1.11.1
#:import date datetime.date

# --- Custom Themed Widgets ---

<ThemedTextInput@TextInput>:
    # Set the background color directly. This will be the fill.
    background_color: app.root.theme_colors[app.root.theme]['surface'] if app.root else (1, 1, 1, 1)
    # VERY IMPORTANT: Disable the default Kivy image-based background.
    background_normal: ''
    background_active: ''

    # Set text colors
    foreground_color: app.root.theme_colors[app.root.theme]['text_primary'] if app.root else (0,0,0,1)
    hint_text_color: app.root.theme_colors[app.root.theme]['text_secondary'] if app.root else (0.5, 0.5, 0.5, 1)
    
    # Add some padding so the text isn't right on the edge.
    padding: [dp(10), (self.height - self.line_height) / 2]

    # Use the canvas to draw a BORDER line, not a filled shape.
    canvas.before:
        Color:
            # Make the border blue when focused, and gray otherwise
            rgba: app.root.theme_colors[app.root.theme]['primary'] if self.focus and app.root else (0.5, 0.5, 0.5, 1)
        Line:
            width: dp(1.5)
            rounded_rectangle: (self.x, self.y, self.width, self.height, dp(8))


<ThemedSpinner@Spinner>:
    background_normal: ''
    background_down: ''
    background_color: 0, 0, 0, 0
    canvas.before:
        Color:
            rgba: app.root.theme_colors[app.root.theme]['primary'] if app.root else (0.12, 0.45, 0.67, 1)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [dp(8)]
    color: app.root.theme_colors[app.root.theme]['on_primary'] if app.root else (1, 1, 1, 1)

# --- Custom App Widgets ---

<HoverButton>:
    canvas.before:
        Color:
            rgba: self.hover_color if self.is_hovered else self.bg_color
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [dp(8),]

<EditTaskPopup>:
    title: "Edit Task Details"
    size_hint: 0.6, 0.6
    min_width: dp(450)
    min_height: dp(350)
    auto_dismiss: False
    title_align: 'center'
    
    BoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        spacing: dp(15)

        GridLayout:
            cols: 2
            spacing: dp(10)
            size_hint_y: None
            height: self.minimum_height

            Label:
                text: 'Task:'
                text_size: self.size
                halign: 'left'
                valign: 'center'
            ThemedTextInput:
                id: task_input
                text: root.task_text
                multiline: False

            Label:
                text: 'Deadline:'
                text_size: self.size
                halign: 'left'
                valign: 'center'
            ThemedTextInput:
                id: deadline_input
                text: root.deadline_text
                hint_text: 'DD-MM-YYYY'
                multiline: False

            Label:
                text: 'Priority:'
                text_size: self.size
                halign: 'left'
                valign: 'center'
            ThemedSpinner:
                id: priority_spinner
                text: root.priority_text
                values: ['Low', 'Medium', 'High']

        Label:
            id: error_label
            size_hint_y: None
            height: dp(20)
            color: [1, 0.2, 0.2, 1]

        BoxLayout:
            size_hint_y: None
            height: dp(40)
            spacing: dp(10)
            
            HoverButton:
                text: 'Save Changes'
                on_press: root.save_changes(task_input.text, deadline_input.text, priority_spinner.text)
                bg_color: app.root.theme_colors[app.root.theme]['primary'] if app.root else (0.12, 0.45, 0.67, 1)
                hover_color: app.root.theme_colors[app.root.theme]['primary_light'] if app.root else (0.4, 0.65, 0.84, 1)
                color: app.root.theme_colors[app.root.theme]['on_primary'] if app.root else (1, 1, 1, 1)

            HoverButton:
                text: 'Cancel'
                on_press: root.dismiss()
                bg_color: [0.5, 0.5, 0.5, 1]
                hover_color: [0.6, 0.6, 0.6, 1]
                color: app.root.theme_colors[app.root.theme]['on_primary'] if app.root else (1, 1, 1, 1)

<TaskItem>:
    size_hint_y: None
    height: dp(52)
    padding: [dp(8), dp(4)]
    spacing: dp(12)
    
    canvas.before:
        Color:
            rgba: app.root.theme_colors[app.root.theme]['selected'] if app.root and root.selected else app.root.theme_colors[app.root.theme]['surface'] if app.root else (1,1,1,1)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [dp(10),]

    CheckBox:
        size_hint_x: None
        width: dp(40)
        active: root.completed
        on_active: root.toggle_complete(self.active)
        color: app.root.theme_colors[app.root.theme]['primary'] if app.root else (0,0,0,1)

    Label:
        text: root.task
        size_hint_x: 0.5
        text_size: self.width, None
        halign: 'left'
        valign: 'middle'
        color: app.root.theme_colors[app.root.theme]['text_primary'] if app.root else (0,0,0,1)
        strikethrough: root.completed
        shorten: True
        shorten_from: 'right'
        ellipsis_options: {'color':self.color, 'underline':False}

    Label:
        text: root.deadline
        size_hint_x: 0.2
        color: app.root.theme_colors[app.root.theme]['text_secondary'] if app.root else (0.5, 0.5, 0.5, 1)

    Label:
        text: root.priority
        size_hint_x: 0.15
        color: {'Low': [0.2, 0.6, 0.2, 1], 'Medium': [0.9, 0.6, 0, 1], 'High': [0.8, 0.2, 0.2, 1]}.get(root.priority, (0,0,0,1))
        bold: True
    
    HoverButton:
        text: 'Edit'
        size_hint: None, None
        size: dp(70), dp(32)
        bg_color: app.root.theme_colors[app.root.theme]['primary'] if app.root else (0.12, 0.45, 0.67, 1)
        hover_color: app.root.theme_colors[app.root.theme]['primary_light'] if app.root else (0.4, 0.65, 0.84, 1)
        color: app.root.theme_colors[app.root.theme]['on_primary'] if app.root else (1, 1, 1, 1)
        on_release: root.edit_task()

<TodoLayout>:
    orientation: 'vertical'
    padding: dp(20)
    spacing: dp(15)
    canvas.before:
        Color:
            rgba: root.theme_colors[root.theme]['background']
        Rectangle:
            pos: self.pos
            size: self.size

    Label:
        text: 'To-Do List Manager'
        size_hint_y: None
        height: dp(50)
        font_size: '24sp'
        color: root.theme_colors[root.theme]['primary']
        bold: True

    BoxLayout:
        orientation: 'vertical'
        size_hint_y: None
        height: dp(60)
        padding: dp(10)
        spacing: dp(10)
        canvas.before:
            Color:
                rgba: root.theme_colors[root.theme]['surface']
            RoundedRectangle:
                pos: self.pos
                size: self.size
                radius: [dp(12),]
            Color:
                rgba: [0,0,0, 0.07]
            RoundedRectangle:
                pos: self.x - dp(2), self.y - dp(2)
                size: self.width + dp(4), self.height + dp(4)
                radius: [dp(14),]
                
        GridLayout:
            cols: 4
            spacing: dp(10)
            
            ThemedTextInput:
                id: task_input
                hint_text: 'Enter a new task...'
                size_hint_x: 0.5
            ThemedTextInput:
                id: deadline_input
                hint_text: f"default: {date.today().strftime('%d-%m-%Y')}"
                size_hint_x: 0.25
            ThemedSpinner:
                id: priority_spinner
                text: 'Medium'
                values: ['Low', 'Medium', 'High']
                size_hint_x: 0.25
            HoverButton:
                text: 'Add Task'
                on_press: root.add_task_ui()
                bg_color: root.theme_colors[root.theme]['primary']
                hover_color: root.theme_colors[root.theme]['primary_light']
                color: root.theme_colors[root.theme]['on_primary']
        
    BoxLayout:
        size_hint_y: None
        height: dp(40)
        spacing: dp(10)
        
        ThemedTextInput:
            id: search_input
            hint_text: 'ï€‚ Search Tasks'
            size_hint_x: 0.3
            on_text: root.search_tasks(self.text)
            
        ThemedSpinner:
            id: filter_spinner
            text: 'All'
            values: ['All', 'Completed', 'Pending', 'High', 'Medium', 'Low']
            on_text: root.apply_filter(self.text)
            
        ThemedSpinner:
            id: theme_spinner
            text: root.theme
            values: ['Light', 'Dark']
            on_text: root.theme = self.text
            
        HoverButton:
            text: 'Remove Selected'
            on_press: root.remove_selected()
            bg_color: root.theme_colors[root.theme]['danger']
            hover_color: root.theme_colors[root.theme]['danger_light']
            color: root.theme_colors[root.theme]['on_primary']

    # --- Task List Header ---
    BoxLayout:
        size_hint_y: None
        height: dp(30)
        padding: [dp(8), 0]
        spacing: dp(12)
        
        Label:
            text: ''
            size_hint_x: None
            width: dp(40)
        Label:
            text: 'Task Description'
            halign: 'left'
            size_hint_x: 0.5
            color: app.root.theme_colors[app.root.theme]['text_secondary'] if app.root else (0.5, 0.5, 0.5, 1)
        Label:
            text: 'Deadline'
            size_hint_x: 0.2
            color: app.root.theme_colors[app.root.theme]['text_secondary'] if app.root else (0.5, 0.5, 0.5, 1)
        Label:
            text: 'Priority'
            size_hint_x: 0.15
            color: app.root.theme_colors[app.root.theme]['text_secondary'] if app.root else (0.5, 0.5, 0.5, 1)
        Label:
            text: 'Action'
            size_hint_x: None
            width: dp(70)
            color: app.root.theme_colors[app.root.theme]['text_secondary'] if app.root else (0.5, 0.5, 0.5, 1)
            
    RecycleView:
        id: task_list
        viewclass: 'TaskItem'
        scroll_type: ['bars', 'content']
        bar_width: dp(8)
        bar_color: app.root.theme_colors[app.root.theme]['primary'] if app.root else (0.12, 0.45, 0.67, 1)
        
        RecycleBoxLayout:
            default_size: None, dp(52)
            default_size_hint: 1, None
            size_hint_y: None
            height: self.minimum_height
            orientation: 'vertical'
            spacing: dp(5)

    Label:
        id: status_bar
        size_hint_y: None
        height: dp(24)
        color: app.root.theme_colors[app.root.theme]['text_secondary'] if app.root else (0.5, 0.5, 0.5, 1)